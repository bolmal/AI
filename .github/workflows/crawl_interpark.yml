name: Run Concert Crawler

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  run-crawler:
    runs-on: ubuntu-latest
    # μ›ν¬ν”λ΅μ°κ°€ μ΄μλ¥Ό μƒμ„±ν•  μ μλ„λ΅ κ¶ν• λ¶€μ—¬
    permissions:
        contents: write
        issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run crawler
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python crawlAI.py
    
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: μƒλ΅μ΄ μΈν„°νν¬ μ½μ„νΈ μ •λ³΄ μ—…λ°μ΄νΈ"
          file_pattern: "crawl_new_concerts/*.json"
    
      # λ‚ μ§ λ³€μ λ§λ“¤κΈ°
      - name: Set date
        id: date
        run: echo "today=$(TZ=Asia/Seoul date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # μ΄μ λ‚΄μ© νμΌ μƒμ„±
      - name: Create issue body file
        run: |
          cat <<EOF > issue_body.md
          ν¬λ΅¤λ¬κ°€ μƒλ΅μ΄ μΈν„°νν¬ μ½μ„νΈ μ •λ³΄λ¥Ό λ°κ²¬ν•μ—¬ μ—…λ°μ΄νΈν–μµλ‹λ‹¤.

          - **μƒμ„±λ νμΌ:** ${{ steps.date.outputs.today }}.json
          - **μμ„Έν λ³΄κΈ°:** [λ¦¬ν¬μ§€ν† λ¦¬μ—μ„ μµμ‹  μ»¤λ°‹ ν™•μΈν•κΈ°](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.commit.outputs.commit_hash }})

          λ‚΄μ©μ„ ν™•μΈν•΄μ£Όμ„Έμ”!
          EOF

      # μ΄μ μƒμ„±
      - name: Create issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: π¶ μΈν„°νν¬ μƒλ΅μ΄ μ½μ„νΈ μ •λ³΄ μ—…λ°μ΄νΈ (${{ steps.date.outputs.today }})
          content-filepath: issue_body.md
          labels: μ½μ„νΈ, ν¬λ΅¤λ§
          token: ${{ secrets.GITHUB_TOKEN }}