name: Run Concert Crawler

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  run-crawler:
    runs-on: ubuntu-latest
    # μ›ν¬ν”λ΅μ°κ°€ μ΄μλ¥Ό μƒμ„±ν•  μ μλ„λ΅ κ¶ν• λ¶€μ—¬
    permissions:
        contents: write
        issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run crawler
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python crawlAI.py
    
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: μƒλ΅μ΄ μΈν„°νν¬ μ½μ„νΈ μ •λ³΄ μ—…λ°μ΄νΈ"
          file_pattern: "crawl_new_concerts/*.json"
    
      - name: Create GitHub Issue on new data
        uses: actions/github-script@v7
        with:
          # μ΄μ μ λ©μ„ μ„¤μ •ν•©λ‹λ‹¤.
          title: "π¶ μΈν„°νν¬ μƒλ΅μ΄ μ½μ„νΈ μ •λ³΄ μ—…λ°μ΄νΈ (${{ env.TODAY }})"
          # μ΄μ λ‚΄μ©μ„ μ„¤μ •ν•©λ‹λ‹¤. Markdownμ„ μ‚¬μ©ν•  μ μμµλ‹λ‹¤.
          body: |
            ν¬λ΅¤λ¬κ°€ μƒλ΅μ΄ μ½μ„νΈ μ •λ³΄λ¥Ό λ°κ²¬ν•μ—¬ μ—…λ°μ΄νΈν–μµλ‹λ‹¤.

            - **μƒμ„±λ νμΌ:** `${{ env.TODAY }}.json`
            - **μμ„Έν λ³΄κΈ°:** [λ¦¬ν¬μ§€ν† λ¦¬μ—μ„ μµμ‹  μ»¤λ°‹ ν™•μΈν•κΈ°](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.commit.outputs.commit_hash }})
            
            λ‚΄μ©μ„ ν™•μΈν•΄μ£Όμ„Έμ”!
          # μ΄μμ— μλ™μΌλ΅ λΌλ²¨μ„ λ‹¬μ•„μ¤λ‹λ‹¤
          labels: "μ½μ„νΈ, ν¬λ΅¤λ§"
        env:
          # λ‚ μ§ λ³€μλ¥Ό μ„¤μ •
          TODAY: $(TZ=Asia/Seoul date +'%Y-%m-%d')