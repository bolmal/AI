name: Run Concert Crawler

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  run-crawler:
    runs-on: ubuntu-latest
    # 워크플로우가 이슈를 생성할 수 있도록 권한 부여
    permissions:
        contents: write
        issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run crawler
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python crawlAI.py
    
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: 새로운 인터파크 콘서트 정보 업데이트"
          file_pattern: "crawl_new_concerts/*.json"
    
      # 날짜 변수 만들기
      - name: Set date
        id: date
        run: echo "today=$(TZ=Asia/Seoul date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # 이슈 내용 파일 생성
      - name: Create issue body file
        run: |
          cat <<EOF > issue_body.md
          크롤러가 새로운 인터파크 콘서트 정보를 발견하여 업데이트했습니다.

          - **생성된 파일:** ${{ steps.date.outputs.today }}.json
          - **자세히 보기:** [리포지토리에서 최신 커밋 확인하기](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.commit.outputs.commit_hash }})

          내용을 확인해주세요!
          EOF

      # 이슈 생성
      - name: Create issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: 🎶 인터파크 새로운 콘서트 정보 업데이트 (${{ steps.date.outputs.today }})
          content-filepath: issue_body.md
          labels: 콘서트, 크롤링
          token: ${{ secrets.GITHUB_TOKEN }}